<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>거래소 비율 계산기</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f4f4f4;
        margin: 0;
      }
      .container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 25px;
      }
      .input-group {
        margin-bottom: 15px;
      }
      .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: bold;
      }
      .input-group input[type="number"] {
        width: calc(100% - 22px); /* Adjusted for padding */
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      .input-group input[type="number"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.1rem rgba(0, 123, 255, 0.25);
      }
      .calculate-button {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s;
      }
      .calculate-button:hover {
        background-color: #0056b3;
      }
      .result {
        margin-top: 25px;
        padding: 15px;
        border: 1px dashed #007bff;
        border-radius: 4px;
        background-color: #e9f7ff;
        font-size: 1.1em;
        color: #333;
        text-align: center;
        min-height: 60px; /* Set a min-height to avoid layout shifts */
      }
      .result p {
        margin: 5px 0;
      }
      .error {
        color: red;
        text-align: center;
        margin-top: 10px;
        min-height: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>거래소 비율 계산기</h1>
      <div class="input-group">
        <label for="chaos">받을 화폐</label>
        <input
          type="number"
          id="chaos"
          placeholder="변옵70개를 10카에 팔고 싶으면 여긴 10을 입력"
          value=""
        />
      </div>
      <div class="input-group">
        <label for="itemA">판매할 아이템</label>
        <input
          type="number"
          id="itemA"
          placeholder="변옵70개를 10카에 팔고싶으면 여긴 70을 입력"
          value=""
        />
      </div>
      <div class="input-group">
        <label for="myItems">보유한 판매 아이템 총 개수</label>
        <input
          type="number"
          id="myItems"
          placeholder="내가 들고있는 변옵 총 개수를 입력"
          value=""
        />
      </div>
      <button id="calculateBtn" class="calculate-button">계산하기</button>
      <div class="result" id="result">
        <p>여기에 계산 결과가 표시됩니다.</p>
      </div>
      <div class="error" id="error"></div>
    </div>

    <script>
      function gcd(a, b) {
        return b === 0 ? a : gcd(b, a % b);
      }

      function findIntegerRatio(num1, num2) {
        const tolerance = 0.002;
        const maxDenominator = 1000;

        if (num1 === 0 || num2 === 0) return { a: 0, b: 0 };

        const targetRatio = num1 / num2;

        for (let den = 1; den <= maxDenominator; den++) {
          const num = Math.round(targetRatio * den);
          if (num === 0) continue;

          if (Math.abs(targetRatio - num / den) < tolerance) {
            const commonDivisor = gcd(num, den);
            return { a: num / commonDivisor, b: den / commonDivisor };
          }
        }

        let multiplier = 1;
        while (true) {
          const n1_check = num1 * multiplier;
          const n2_check = num2 * multiplier;
          if (
            Math.abs(n1_check - Math.round(n1_check)) < 1e-9 &&
            Math.abs(n2_check - Math.round(n2_check)) < 1e-9
          ) {
            break;
          }
          multiplier *= 10;
          if (multiplier > 100000) {
            const commonDivisor = gcd(Math.round(num1), Math.round(num2));
            return {
              a: Math.round(num1) / commonDivisor,
              b: Math.round(num2) / commonDivisor,
            };
          }
        }
        const n1 = Math.round(num1 * multiplier);
        const n2 = Math.round(num2 * multiplier);
        const commonDivisor = gcd(n1, n2);
        return { a: n1 / commonDivisor, b: n2 / commonDivisor };
      }

      function calculateExchange() {
        const chaosInput = parseFloat(document.getElementById("chaos").value);
        const itemAInput = parseFloat(document.getElementById("itemA").value);
        const myItems = parseInt(document.getElementById("myItems").value);

        const resultDiv = document.getElementById("result");
        const errorDiv = document.getElementById("error");
        const chaosEl = document.getElementById("chaos");

        errorDiv.textContent = "";

        if (
          isNaN(chaosInput) ||
          isNaN(itemAInput) ||
          chaosInput <= 0 ||
          itemAInput <= 0
        ) {
          resultDiv.innerHTML =
            "<p>비율을 계산하려면 위 두 칸을 모두 입력하세요.</p>";
          chaosEl.focus();
          chaosEl.select();
          return;
        }

        let chaosPerTrade, itemAPerTrade;
        let ratioText;

        if (Number.isInteger(chaosInput) && Number.isInteger(itemAInput)) {
          chaosPerTrade = chaosInput;
          itemAPerTrade = itemAInput;
          ratioText = `거래 비율 <strong>${chaosPerTrade} : ${itemAPerTrade}</strong>`;
        } else {
          const ratio = findIntegerRatio(chaosInput, itemAInput);
          chaosPerTrade = ratio.a;
          itemAPerTrade = ratio.b;
          ratioText = `거래 비율 <strong>${chaosPerTrade} : ${itemAPerTrade}</strong>`;
        }

        if (isNaN(myItems) || myItems < 0) {
          resultDiv.innerHTML = `<p>${ratioText}</p><p>거래 내용을 계산하려면 소지한 아이템 개수를 입력하세요.</p>`;
          chaosEl.focus();
          chaosEl.select();
          return;
        }

        if (itemAPerTrade === 0) {
          errorDiv.textContent =
            "비율 계산에 실패했습니다 (0으로 나눌 수 없음).";
          resultDiv.innerHTML = "";
          chaosEl.focus();
          chaosEl.select();
          return;
        }

        const numberOfTrades = Math.floor(myItems / itemAPerTrade);
        const totalChaosObtained = numberOfTrades * chaosPerTrade;
        const remainingItems = myItems % itemAPerTrade;

        let tradeText = "";
        if (myItems === 0) {
          tradeText = `아이템이 없습니다.`;
        } else if (numberOfTrades === 0) {
          tradeText = `거래를 할 만큼 아이템이 충분하지 않습니다. (최소 <strong>${itemAPerTrade}</strong>개 필요)`;
        } else {
          tradeText =
            `<strong>${totalChaosObtained}</strong>개에 <strong>${
              numberOfTrades * itemAPerTrade
            }</strong>개 등록<br>` + `(거래 후 ${remainingItems}개 남음)`;
        }

        resultDiv.innerHTML = `<p>${ratioText}</p><p>${tradeText}</p>`;

        chaosEl.focus();
        chaosEl.select();
      }

      function handleEnter(event) {
        if (event.key === "Enter") {
          calculateExchange();
        }
      }

      document
        .getElementById("calculateBtn")
        .addEventListener("click", calculateExchange);
      document.getElementById("chaos").addEventListener("keydown", handleEnter);
      document.getElementById("itemA").addEventListener("keydown", handleEnter);
      document
        .getElementById("myItems")
        .addEventListener("keydown", handleEnter);

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("chaos").focus();
      });
    </script>
  </body>
</html>
